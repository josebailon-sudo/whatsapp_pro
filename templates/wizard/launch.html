{% extends "base.html" %}

{% block title %}Lanzar Campaña - Asistente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <div class="progress" style="height: 30px;">
            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%;">
                Paso 5 de 5 - ¡Lanzamiento!
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Panel Principal -->
        <div class="col-lg-8">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-rocket-takeoff-fill"></i> {{ campaign.name }}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Estado -->
                    <div class="alert {% if campaign.status == 'sending' %}alert-success{% elif campaign.status == 'paused' %}alert-warning{% elif campaign.status == 'completed' %}alert-info{% else %}alert-secondary{% endif %}">
                        <h4 class="mb-0">
                            Estado: 
                            {% if campaign.status == 'ready' %}
                                <span class="badge bg-secondary">Listo para Iniciar</span>
                            {% elif campaign.status == 'sending' %}
                                <span class="badge bg-success">
                                    <span class="spinner-border spinner-border-sm"></span> Enviando...
                                </span>
                            {% elif campaign.status == 'paused' %}
                                <span class="badge bg-warning">⏸️ Pausado</span>
                            {% elif campaign.status == 'completed' %}
                                <span class="badge bg-info">✅ Completado</span>
                            {% endif %}
                        </h4>
                    </div>

                    <!-- Barra de Progreso -->
                    <div class="mb-4">
                        <h5>Progreso General:</h5>
                        <div class="progress" style="height: 40px;">
                            <div class="progress-bar bg-success progress-bar-striped {% if is_active %}progress-bar-animated{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ progress_percent }}%;">
                                {{ progress_percent|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>{{ messages_stats.sent|add:messages_stats.failed }} de {{ campaign.total_contacts }}</span>
                            <span>Enviados: {{ messages_stats.sent }} | Fallidos: {{ messages_stats.failed }}</span>
                        </div>
                    </div>

                    <!-- Estadísticas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <div class="card bg-warning text-dark text-center">
                                <div class="card-body py-3">
                                    <h2 class="mb-0">{{ messages_stats.pending }}</h2>
                                    <small>Pendientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-info text-white text-center">
                                <div class="card-body py-3">
                                    <h2 class="mb-0">{{ messages_stats.sending }}</h2>
                                    <small>Enviando</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white text-center">
                                <div class="card-body py-3">
                                    <h2 class="mb-0">{{ messages_stats.sent }}</h2>
                                    <small>Enviados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-danger text-white text-center">
                                <div class="card-body py-3">
                                    <h2 class="mb-0">{{ messages_stats.failed }}</h2>
                                    <small>Fallidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white text-center">
                                <div class="card-body py-3">
                                    <h2 class="mb-0">{{ messages_stats.cancelled }}</h2>
                                    <small>Cancelados</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="d-flex gap-2 mb-4 flex-wrap">
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            {% if campaign.status == 'ready' or campaign.status == 'paused' %}
                                <button type="submit" name="action" value="{% if campaign.status == 'paused' %}resume{% else %}start{% endif %}" 
                                        class="btn btn-success btn-lg">
                                    <i class="bi bi-play-fill"></i> {% if campaign.status == 'paused' %}Reanudar{% else %}Iniciar Envío{% endif %}
                                </button>
                            {% endif %}
                            
                            {% if campaign.status == 'sending' %}
                                <button type="submit" name="action" value="pause" class="btn btn-warning btn-lg">
                                    <i class="bi bi-pause-fill"></i> Pausar
                                </button>
                                <button type="submit" name="action" value="cancel" class="btn btn-danger btn-lg" 
                                        onclick="return confirm('¿Seguro que quieres cancelar esta campaña? Esta acción no se puede deshacer.')">
                                    <i class="bi bi-x-circle-fill"></i> Cancelar Envío
                                </button>
                            {% endif %}
                            
                            {% if campaign.status == 'paused' %}
                                <button type="submit" name="action" value="cancel" class="btn btn-danger btn-lg" 
                                        onclick="return confirm('¿Seguro que quieres cancelar esta campaña? Esta acción no se puede deshacer.')">
                                    <i class="bi bi-x-circle-fill"></i> Cancelar Campaña
                                </button>
                            {% endif %}
                            
                            {% if messages_stats.cancelled > 0 or messages_stats.failed > 0 %}
                                <button type="submit" name="action" value="cleanup" class="btn btn-outline-danger btn-lg" 
                                        onclick="return confirm('¿Eliminar {{ messages_stats.cancelled }} mensajes cancelados y {{ messages_stats.failed }} fallidos? Esta acción no se puede deshacer.')">
                                    <i class="bi bi-trash-fill"></i> Limpiar ({{ messages_stats.cancelled|add:messages_stats.failed }})
                                </button>
                            {% endif %}
                        </form>
                        
                        <button class="btn btn-outline-secondary btn-lg" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>

                    <!-- Mensajes Recientes -->
                    <h5>Últimos Mensajes:</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Contacto</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for msg in recent_messages %}
                                <tr>
                                    <td>
                                        <i class="bi bi-person-fill"></i> {{ msg.contact.name }}
                                        <br><small class="text-muted">{{ msg.contact.phone }}</small>
                                    </td>
                                    <td>
                                        {% if msg.status == 'sent' %}
                                            <span class="badge bg-success">✓ Enviado</span>
                                        {% elif msg.status == 'sending' %}
                                            <span class="badge bg-info">→ Enviando</span>
                                        {% elif msg.status == 'failed' %}
                                            <span class="badge bg-danger">✗ Fallido</span>
                                        {% elif msg.status == 'cancelled' %}
                                            <span class="badge bg-secondary">✗ Cancelado</span>
                                        {% else %}
                                            <span class="badge bg-warning">⏳ Pendiente</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ msg.created_at|date:"H:i:s" }}</small></td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-muted">No hay mensajes aún</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle-fill"></i> Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Velocidad:</strong> {{ campaign.send_speed }} msg/min</p>
                    <p><strong>Tamaño bloque:</strong> {{ campaign.batch_size }}</p>
                    <p><strong>Pausa entre bloques:</strong> {{ campaign.delay_between_batches }}s</p>
                    <p><strong>Delay entre mensajes:</strong> {{ campaign.delay_between_messages|floatformat:1 }}s</p>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-lightbulb-fill"></i> Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Puedes pausar y reanudar cuando quieras</li>
                        <li>Actualiza la página para ver el progreso</li>
                        <li>El worker procesa automáticamente</li>
                        <li>Los fallidos se pueden reintentar</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">Worker Status</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <span class="badge bg-success">
                            <span class="spinner-border spinner-border-sm"></span> Activo
                        </span>
                    </p>
                    <small class="text-muted">
                        Ejecuta: <code>python manage.py run_worker</code> en otra terminal
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación Final -->
    <div class="row mt-4">
        <div class="col text-center">
            {% if campaign.status == 'completed' %}
                <a href="{% url 'index' %}" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-house-fill"></i> Volver al Inicio
                </a>
                <a href="{% url 'wizard_welcome' %}" class="btn btn-outline-success btn-lg px-5 ms-2">
                    <i class="bi bi-arrow-repeat"></i> Nueva Campaña
                </a>
            {% else %}
                <a href="{% url 'campaign_detail' campaign.id %}" class="btn btn-outline-secondary">
                    Ver Detalle Completo
                </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Auto-refresh cada 5 segundos si está enviando
{% if is_active %}
setTimeout(function() {
    location.reload();
}, 5000);
{% endif %}
</script>
{% endblock %}
