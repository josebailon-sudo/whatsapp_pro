{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Plantilla - WhatsApp Pro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-pencil-square"></i> Editar Plantilla: {{ template.name }}</h2>
            <p class="text-muted">Modifica tu plantilla de mensaje</p>
        </div>
    </div>

    <form method="post" id="templateForm">
        {% csrf_token %}
        <div class="row">
            <!-- Editor de Plantilla -->
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-pencil"></i> Editor de Mensaje</h5>
                    </div>
                    <div class="card-body">
                        <!-- Información básica -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre de la Plantilla <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control form-control-lg" value="{{ template.name }}" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Categoría</label>
                                <input type="text" name="category" class="form-control" value="{{ template.category }}" list="categories">
                                <datalist id="categories">
                                    {% for cat in categories %}
                                    <option value="{{ cat }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Estado</label>
                                <div class="form-check form-switch" style="padding-top: 0.5rem;">
                                    <input class="form-check-input" type="checkbox" name="active" id="activeSwitch" {% if template.active %}checked{% endif %}>
                                    <label class="form-check-label" for="activeSwitch">Activa</label>
                                </div>
                            </div>
                        </div>

                        <!-- Editor de contenido -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contenido del Mensaje <span class="text-danger">*</span></label>
                            <textarea name="content" id="messageContent" class="form-control" rows="10" required>{{ template.content }}</textarea>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Contador: <span id="charCount">0</span> caracteres
                            </small>
                        </div>

                        <!-- Barra de herramientas de variables -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Insertar Variables</label>
                            <div class="btn-group flex-wrap" role="group">
                                {% for var in available_vars %}
                                <button type="button" class="btn btn-sm btn-outline-secondary insert-var" data-var="{{ var }}">
                                    <i class="bi bi-code"></i> {{'{'}}{{ var }}{{'}'}}
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'templates_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Previa -->
            <div class="col-lg-5">
                <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> Vista Previa</h5>
                    </div>
                    <div class="card-body">
                        <!-- Simulador de WhatsApp -->
                        <div class="whatsapp-preview p-3 rounded" style="background: #e5ddd5; min-height: 300px;">
                            <div class="message-bubble bg-white p-3 rounded shadow-sm" style="max-width: 85%; float: right; clear: both;">
                                <div id="previewContent" style="white-space: pre-wrap; word-wrap: break-word;"></div>
                                <div class="text-end mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-check2-all text-primary"></i> 
                                        <span id="previewTime">10:30</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Datos de ejemplo -->
                        {% if sample_contact %}
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong><i class="bi bi-person-circle"></i> Ejemplo con:</strong><br>
                                Nombre: {{ sample_contact.name }}<br>
                                Teléfono: {{ sample_contact.phone }}<br>
                                Grupo: {{ sample_contact.group }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.message-bubble {
    position: relative;
    margin-bottom: 10px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
}

.message-bubble::after {
    content: '';
    position: absolute;
    right: -10px;
    top: 0;
    width: 0;
    height: 0;
    border-left: 10px solid white;
    border-bottom: 10px solid transparent;
}

.insert-var {
    margin: 2px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Mismo código JavaScript que template_create.html
const textarea = document.getElementById('messageContent');
const charCount = document.getElementById('charCount');
const previewContent = document.getElementById('previewContent');
const previewTime = document.getElementById('previewTime');

const sampleData = {
    nombre: '{{ sample_contact.name|default:"Juan Pérez" }}',
    telefono: '{{ sample_contact.phone|default:"+593987654321" }}',
    grupo: '{{ sample_contact.group|default:"General" }}',
    email: '{{ sample_contact.email|default:"ejemplo@email.com" }}',
    fecha: new Date().toLocaleDateString('es-ES'),
    hora: new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}),
    saludo: 'Hola'
};

setInterval(() => {
    previewTime.textContent = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
}, 60000);

previewTime.textContent = sampleData.hora;

textarea.addEventListener('input', function() {
    const count = this.value.length;
    charCount.textContent = count;
    
    let preview = this.value || 'Escribe tu mensaje para ver la vista previa...';
    Object.keys(sampleData).forEach(key => {
        const regex = new RegExp(`{${key}}`, 'gi');
        preview = preview.replace(regex, sampleData[key]);
    });
    
    previewContent.textContent = preview;
    
    if (count > 1000) {
        charCount.classList.add('text-danger');
    } else if (count > 500) {
        charCount.classList.add('text-warning');
    }
});

document.querySelectorAll('.insert-var').forEach(button => {
    button.addEventListener('click', function() {
        const varName = this.dataset.var;
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        
        textarea.value = textBefore + `{${varName}}` + textAfter;
        textarea.focus();
        
        const newPos = cursorPos + varName.length + 2;
        textarea.setSelectionRange(newPos, newPos);
        textarea.dispatchEvent(new Event('input'));
    });
});

textarea.dispatchEvent(new Event('input'));
</script>
{% endblock %}
