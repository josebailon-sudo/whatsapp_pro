{% extends "base.html" %}
{% load static %}

{% block title %}Envío Rápido - WhatsApp Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center">
                <i class="bi bi-lightning-charge-fill text-warning display-4 me-3"></i>
                <div>
                    <h2 class="mb-1">⚡ Envío Rápido</h2>
                    <p class="text-muted mb-0">Escribe y envía un mensaje ahora sin guardar plantilla</p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="quickSendForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Panel Izquierdo - Editor -->
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning bg-gradient text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square"></i> Escribe tu Mensaje
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Barra de Variables -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Variables Disponibles:</label>
                            <div class="btn-group flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('nombre')">
                                    {nombre}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('telefono')">
                                    {telefono}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('grupo')">
                                    {grupo}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('email')">
                                    {email}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('fecha')">
                                    {fecha}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('hora')">
                                    {hora}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertVariable('saludo')">
                                    {saludo}
                                </button>
                            </div>
                        </div>

                        <!-- Editor de Texto -->
                        <div class="mb-3">
                            <label for="message" class="form-label fw-bold">Mensaje:</label>
                            <textarea 
                                class="form-control" 
                                name="message" 
                                id="message" 
                                rows="12" 
                                placeholder="Escribe tu mensaje aquí... Puedes usar variables como {nombre}, {telefono}, etc."
                                required
                                oninput="updatePreview()"></textarea>
                            <div class="form-text">
                                Caracteres: <span id="charCount">0</span> | 
                                Las variables se reemplazarán automáticamente con los datos de cada contacto
                            </div>
                        </div>

                        <!-- Selector de Destinatarios -->
                        <div class="card bg-light">
                            <div class="card-body">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-people-fill"></i> ¿A quién enviar?
                                </label>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="recipient_filter" 
                                           id="filter_all" value="all" checked onchange="toggleRecipientFilter()">
                                    <label class="form-check-label" for="filter_all">
                                        <strong>Todos los contactos</strong> ({{ contacts.count }} contactos)
                                    </label>
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="recipient_filter" 
                                           id="filter_groups" value="groups" onchange="toggleRecipientFilter()">
                                    <label class="form-check-label" for="filter_groups">
                                        <strong>Por grupos</strong>
                                    </label>
                                </div>
                                
                                <div id="groups_selection" class="ms-4 mb-3" style="display: none;">
                                    {% for group in groups %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="groups" 
                                               value="{{ group }}" id="group_{{ forloop.counter }}">
                                        <label class="form-check-label" for="group_{{ forloop.counter }}">
                                            {{ group }}
                                        </label>
                                    </div>
                                    {% empty %}
                                    <p class="text-muted mb-0">No hay grupos disponibles</p>
                                    {% endfor %}
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="recipient_filter" 
                                           id="filter_custom" value="custom" onchange="toggleRecipientFilter()">
                                    <label class="form-check-label" for="filter_custom">
                                        <strong>Selección manual</strong>
                                    </label>
                                </div>
                                
                                <div id="custom_selection" class="ms-4" style="display: none; max-height: 300px; overflow-y: auto;">
                                    {% for contact in contacts %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="contacts" 
                                               value="{{ contact.id }}" id="contact_{{ contact.id }}">
                                        <label class="form-check-label" for="contact_{{ contact.id }}">
                                            {{ contact.name }} ({{ contact.phone }})
                                        </label>
                                    </div>
                                    {% empty %}
                                    <p class="text-muted mb-0">No hay contactos disponibles</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Derecho - Preview WhatsApp -->
            <div class="col-lg-5">
                <div class="position-sticky" style="top: 20px;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-whatsapp"></i> Vista Previa
                            </h5>
                        </div>
                        <div class="card-body" style="background: linear-gradient(to bottom, #e5ddd5 0%, #e5ddd5 100%); min-height: 400px;">
                            <!-- Simulación de burbuja de WhatsApp -->
                            <div class="d-flex justify-content-end mb-3">
                                <div class="card shadow-sm" style="max-width: 85%; background-color: #dcf8c6; border-radius: 7.5px;">
                                    <div class="card-body py-2 px-3">
                                        <div id="preview" style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 14px; color: #303030;">
                                            <span class="text-muted fst-italic">Tu mensaje aparecerá aquí...</span>
                                        </div>
                                        <div class="text-end mt-1">
                                            <small class="text-muted" style="font-size: 11px;">
                                                <i class="bi bi-clock"></i> {{ "now"|date:"H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if sample_contact %}
                            <div class="alert alert-info py-2 px-3">
                                <small>
                                    <strong>Vista previa con:</strong><br>
                                    Nombre: {{ sample_contact.name }}<br>
                                    Teléfono: {{ sample_contact.phone }}<br>
                                    Grupo: {{ sample_contact.group }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botón de Envío -->
                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-warning btn-lg shadow">
                            <i class="bi bi-lightning-charge-fill"></i> Enviar Ahora
                        </button>
                        <a href="{% url 'campaigns_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Insertar variable en el cursor
function insertVariable(varName) {
    const textarea = document.getElementById('message');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    textarea.value = textBefore + '{' + varName + '}' + textAfter;
    textarea.focus();
    
    // Mover cursor después de la variable insertada
    const newCursorPos = cursorPos + varName.length + 2;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    updatePreview();
}

// Actualizar preview en tiempo real
function updatePreview() {
    const message = document.getElementById('message').value;
    const preview = document.getElementById('preview');
    const charCount = document.getElementById('charCount');
    
    charCount.textContent = message.length;
    
    if (message.trim() === '') {
        preview.innerHTML = '<span class="text-muted fst-italic">Tu mensaje aparecerá aquí...</span>';
        return;
    }
    
    // Reemplazar variables con datos de ejemplo
    let previewText = message;
    {% if sample_contact %}
    previewText = previewText.replace(/{nombre}/g, '{{ sample_contact.name }}');
    previewText = previewText.replace(/{telefono}/g, '{{ sample_contact.phone }}');
    previewText = previewText.replace(/{grupo}/g, '{{ sample_contact.group }}');
    previewText = previewText.replace(/{email}/g, '{{ sample_contact.email|default:"" }}');
    {% endif %}
    previewText = previewText.replace(/{fecha}/g, '{{ "now"|date:"d/m/Y" }}');
    previewText = previewText.replace(/{hora}/g, '{{ "now"|date:"H:i" }}');
    previewText = previewText.replace(/{saludo}/g, 'Dios te bendiga');
    
    preview.textContent = previewText;
}

// Mostrar/ocultar opciones de filtro
function toggleRecipientFilter() {
    const filterType = document.querySelector('input[name="recipient_filter"]:checked').value;
    
    document.getElementById('groups_selection').style.display = 
        filterType === 'groups' ? 'block' : 'none';
    document.getElementById('custom_selection').style.display = 
        filterType === 'custom' ? 'block' : 'none';
}

// Validación antes de enviar
document.getElementById('quickSendForm').addEventListener('submit', function(e) {
    const message = document.getElementById('message').value.trim();
    
    if (message === '') {
        e.preventDefault();
        alert('⚠️ Por favor escribe un mensaje antes de enviar.');
        return false;
    }
    
    const filterType = document.querySelector('input[name="recipient_filter"]:checked').value;
    
    if (filterType === 'groups') {
        const selectedGroups = document.querySelectorAll('input[name="groups"]:checked');
        if (selectedGroups.length === 0) {
            e.preventDefault();
            alert('⚠️ Selecciona al menos un grupo.');
            return false;
        }
    }
    
    if (filterType === 'custom') {
        const selectedContacts = document.querySelectorAll('input[name="contacts"]:checked');
        if (selectedContacts.length === 0) {
            e.preventDefault();
            alert('⚠️ Selecciona al menos un contacto.');
            return false;
        }
    }
    
    return confirm('✅ ¿Confirmas el envío? Los mensajes se agregarán a la cola para procesamiento.');
});
</script>

<style>
/* Estilos adicionales para WhatsApp look */
.form-check-input:checked {
    background-color: #25D366;
    border-color: #25D366;
}

.btn-warning {
    background-color: #FFC107;
    border-color: #FFC107;
    color: #000;
    font-weight: bold;
}

.btn-warning:hover {
    background-color: #FFB300;
    border-color: #FFB300;
    color: #000;
}

#preview {
    word-wrap: break-word;
}
</style>
{% endblock %}
